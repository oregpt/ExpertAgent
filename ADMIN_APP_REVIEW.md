# Agent-in-a-Box v2 â€” Platform Admin App Review

**Reviewer:** Senior Engineer (automated review)
**Date:** 2025-07-11
**Admin App Path:** `agentinabox_platform_admin/`
**v2 License System:** `agentinabox_v2/server/src/licensing/`

---

## Executive Summary

The admin app is a well-built Next.js 14 application with PostgreSQL (Drizzle ORM), JWT license generation, GitHub repo provisioning, and a clean Tailwind CSS UI. **However, it was built against v1's feature set and is critically out of date for v2.** Licenses generated by this admin app today will silently disable 5 key v2 features for every customer.

**Severity breakdown:** ğŸ”´ 5 must-fix | ğŸŸ¡ 7 should-fix | ğŸŸ¢ 4 nice-to-have

---

## A. Compatibility Check

### A1. ğŸ”´ CRITICAL: 5 v2 Feature Flags Are MISSING

The admin app's `LicenseFeatures` interface (defined in `lib/db/schema.ts` lines 149-157) has only 7 flags:

```typescript
// Admin app â€” CURRENT (v1)
interface LicenseFeatures {
  multiAgent: boolean;
  maxAgents: number;
  multimodal: boolean;
  mcpHub: boolean;
  allowedCapabilities: string[];
  customBranding: boolean;
  gitlabKbSync: boolean;
}
```

v2's `FeatureFlags` interface (`server/src/licensing/features.ts`) has **12 fields**. These 5 are missing from the admin app:

| Flag | Type | What It Controls |
|------|------|-----------------|
| `soulMemory` | boolean | Self-evolving agent personality & memory (v2 signature feature) |
| `deepTools` | boolean | Web search, web fetch, real-world tools |
| `proactive` | boolean | Heartbeats, cron jobs, proactive behavior |
| `backgroundAgents` | boolean | Sub-agent spawning for fire-and-forget tasks |
| `multiChannel` | boolean | Slack, Teams, webhooks â€” anything beyond widget |

**Impact:** When v2 validates a license generated by this admin app, it does:
```typescript
soulMemory: decoded.features.soulMemory ?? BASE_FEATURES.soulMemory,
```
Since the JWT payload won't contain these keys, `??` falls back to `BASE_FEATURES` where all 5 are `false`. **Every customer â€” even enterprise â€” loses soul/memory, deep tools, proactive, background agents, and multi-channel.**

### A2. ğŸ”´ Tier Presets Don't Match v2

Comparing `lib/license.ts` `DEFAULT_TIER_TEMPLATES` (admin app) vs `license.ts` `TIER_PRESETS` (v2):

#### Starter Tier

| Flag | Admin App | v2 | Match? |
|------|-----------|-----|--------|
| multiAgent | false | false | âœ… |
| maxAgents | 1 | 1 | âœ… |
| multimodal | **false** | **true** | âŒ |
| mcpHub | **false** | **true** | âŒ |
| allowedCapabilities | **[]** | **['*']** | âŒ |
| customBranding | false | false | âœ… |
| gitlabKbSync | false | false | âœ… |
| soulMemory | âŒ MISSING | false | âŒ |
| deepTools | âŒ MISSING | false | âŒ |
| proactive | âŒ MISSING | false | âŒ |
| backgroundAgents | âŒ MISSING | false | âŒ |
| multiChannel | âŒ MISSING | false | âŒ |

**Starter is significantly weaker in admin app** â€” no multimodal, no MCP Hub, no capabilities. v2 starter is meant to be "v1 equivalent" with widget + RAG + basic MCP tools.

#### Pro Tier

| Flag | Admin App | v2 | Match? |
|------|-----------|-----|--------|
| multiAgent | true | true | âœ… |
| maxAgents | 5 | 5 | âœ… |
| multimodal | true | true | âœ… |
| mcpHub | true | true | âœ… |
| allowedCapabilities | **['anyapi','calendar',...]** | **['*']** | âŒ |
| customBranding | true | true | âœ… |
| gitlabKbSync | **false** | **true** | âŒ |
| soulMemory | âŒ MISSING | **true** | âŒ |
| deepTools | âŒ MISSING | **true** | âŒ |
| proactive | âŒ MISSING | false | âŒ (default ok) |
| backgroundAgents | âŒ MISSING | false | âŒ (default ok) |
| multiChannel | âŒ MISSING | **true** | âŒ |

**Pro is crippled** â€” missing soul/memory, deep tools, multi-channel, gitlab sync. Limited capabilities instead of wildcard.

#### Enterprise Tier

| Flag | Admin App | v2 | Match? |
|------|-----------|-----|--------|
| multiAgent | true | true | âœ… |
| maxAgents | 100 | 100 | âœ… |
| multimodal | true | true | âœ… |
| mcpHub | true | true | âœ… |
| allowedCapabilities | ['*'] | ['*'] | âœ… |
| customBranding | true | true | âœ… |
| gitlabKbSync | true | true | âœ… |
| soulMemory | âŒ MISSING | **true** | âŒ |
| deepTools | âŒ MISSING | **true** | âŒ |
| proactive | âŒ MISSING | **true** | âŒ |
| backgroundAgents | âŒ MISSING | **true** | âŒ |
| multiChannel | âŒ MISSING | **true** | âŒ |

**Enterprise loses all 5 v2 features.**

### A3. Extra "Base" Tier in Admin App

The admin app defines a `base` tier that doesn't exist in v2's `TIER_PRESETS`. v2 has only `starter | pro | enterprise`. This isn't harmful but is confusing â€” it duplicates `BASE_FEATURES` as a selectable tier.

### A4. âœ… JWT Signing Is Compatible

- Both use `jsonwebtoken` npm package
- Both use `HS256` (default)
- Both read from `process.env.LICENSE_SECRET`
- Payload structure matches: `{ org, name, features, issuedAt }` plus JWT's `exp`/`iat`
- Admin app correctly rejects missing/default secret

### A5. âœ… Payload Field Names Match

The JWT payload fields (`org`, `name`, `features`, `issuedAt`) are identical between admin app and v2. No naming mismatches.

---

## B. Feature Completeness

| Capability | Status | Notes |
|------------|--------|-------|
| Create licenses for all 3 tiers | âœ… (partial) | Tier presets exist but don't match v2 |
| Custom feature combinations | âœ… | Via tier template editor or direct API |
| Expiration dates | âœ… | 30d / 90d / 180d / 365d / 730d options |
| List existing licenses | âœ… | Via customer detail page + history endpoint |
| View license details | âœ… | License key display with copy button |
| Revoke licenses | âœ… | With required reason, stored in DB |
| Decode/inspect license keys | âœ… | `decodeLicenseWithoutVerification()` exists in lib |
| License history | âœ… | Full history with revocation tracking |
| Customer management | âœ… | Full CRUD with search, filter, status tracking |
| GitHub repo provisioning | âœ… | Template-based repo creation + collaborator management |
| Tier template management | âœ… | CRUD for tier templates with feature editor UI |
| Authentication | âœ… | Simple password auth with cookie session |

**The infrastructure is solid â€” it just needs the v2 features added to its data model.**

---

## C. Code Quality

### C1. Architecture â€” Good

- Clean Next.js 14 App Router structure
- Proper separation: `lib/` for business logic, `app/api/` for routes, `components/` for UI
- Drizzle ORM with proper schema, relations, and migrations
- TypeScript throughout

### C2. ğŸŸ¡ Bug: Customer Detail Page Has Stale License UI

`app/customers/[id]/page.tsx` contains a completely separate, legacy license generation flow (lines ~90-120):

```typescript
// STALE: These are v1-era feature strings, NOT FeatureFlags objects
const licenseTierFeatures: Record<string, string[]> = {
  starter: ['basic_agents', 'single_user', 'community_support'],
  pro: ['basic_agents', 'advanced_agents', 'multi_user', ...],
  enterprise: ['basic_agents', 'advanced_agents', ... 'custom_integrations'],
};
```

This page sends `{ tier, features: string[], expiresInDays }` to the license API. The API route at `app/api/customers/[id]/license/route.ts` checks for `tierTemplateId` first, then `features` â€” but the features it receives from this page are string arrays like `['basic_agents']`, not `LicenseFeatures` objects. The API will construct a `LicenseFeatures` object with all `false`/defaults since none of the string values map to the boolean flags.

**Result:** Generating a license from the customer detail page produces a license with BASE_FEATURES regardless of tier selected.

### C3. ğŸŸ¡ Security: Auth Cookie Is Weak

`lib/auth.ts` uses a static string `'authenticated'` as the cookie value:
```typescript
cookieStore.set(AUTH_COOKIE_NAME, 'authenticated', { ... });
```
Anyone who sets `admin_auth=authenticated` cookie gets full access. Should use a signed/encrypted session token.

### C4. ğŸŸ¡ Security: License Secret Stored in DB as Plaintext

Settings page allows storing `license_secret` in the database. The `appSettings` table stores it as plaintext `text`. While the DB should be secured, this is a sensitive secret that signs all customer licenses.

### C5. ğŸŸ¢ Code Quality Nits

- `package.json` name is `"nextjs_temp"` â€” should be `"agentinabox-platform-admin"`
- Hundreds of `tmpclaude-*` temp directories in the project root (cleanup needed)
- `app/customers/[id]/page.tsx` is 2300+ lines â€” should be decomposed into components
- The `allFeatures` array in the customer detail page defines features (`basic_agents`, `sso`, etc.) that don't exist in the actual license system

---

## D. Required Changes

### ğŸ”´ Must Fix (Will Break)

#### D1. Add Missing Feature Flags to LicenseFeatures Interface

**File:** `lib/db/schema.ts` (lines 149-157)

**Change:** Add the 5 missing v2 flags:

```typescript
export interface LicenseFeatures {
  multiAgent: boolean;
  maxAgents: number;
  multimodal: boolean;
  mcpHub: boolean;
  allowedCapabilities: string[];
  customBranding: boolean;
  gitlabKbSync: boolean;
  // v2 additions:
  soulMemory: boolean;
  deepTools: boolean;
  proactive: boolean;
  backgroundAgents: boolean;
  multiChannel: boolean;
}
```

#### D2. Update BASE_FEATURES and FULL_FEATURES

**File:** `lib/license.ts` (lines 24-45)

**Change:**
```typescript
export const BASE_FEATURES: LicenseFeatures = {
  multiAgent: false,
  maxAgents: 1,
  multimodal: false,
  mcpHub: false,
  allowedCapabilities: [],
  customBranding: false,
  gitlabKbSync: false,
  soulMemory: false,
  deepTools: false,
  proactive: false,
  backgroundAgents: false,
  multiChannel: false,
};

export const FULL_FEATURES: LicenseFeatures = {
  multiAgent: true,
  maxAgents: 999,
  multimodal: true,
  mcpHub: true,
  allowedCapabilities: ['*'],
  customBranding: true,
  gitlabKbSync: true,
  soulMemory: true,
  deepTools: true,
  proactive: true,
  backgroundAgents: true,
  multiChannel: true,
};
```

#### D3. Update DEFAULT_TIER_TEMPLATES to Match v2 TIER_PRESETS

**File:** `lib/license.ts` (lines 50-110)

**Change:** Replace with v2-aligned presets (remove `base`, update `starter`/`pro`/`enterprise`):

```typescript
export const DEFAULT_TIER_TEMPLATES = {
  starter: {
    name: 'Starter',
    description: 'v1 equivalent â€” widget + RAG + basic MCP tools',
    features: {
      multiAgent: false,
      maxAgents: 1,
      multimodal: true,
      mcpHub: true,
      allowedCapabilities: ['*'],
      customBranding: false,
      gitlabKbSync: false,
      soulMemory: false,
      deepTools: false,
      proactive: false,
      backgroundAgents: false,
      multiChannel: false,
    },
  },
  pro: {
    name: 'Pro',
    description: 'Multi-agent + soul/memory + deep tools + multi-channel + branding',
    features: {
      multiAgent: true,
      maxAgents: 5,
      multimodal: true,
      mcpHub: true,
      allowedCapabilities: ['*'],
      customBranding: true,
      gitlabKbSync: true,
      soulMemory: true,
      deepTools: true,
      proactive: false,
      backgroundAgents: false,
      multiChannel: true,
    },
  },
  enterprise: {
    name: 'Enterprise',
    description: 'Everything unlocked, max scale',
    features: {
      multiAgent: true,
      maxAgents: 100,
      multimodal: true,
      mcpHub: true,
      allowedCapabilities: ['*'],
      customBranding: true,
      gitlabKbSync: true,
      soulMemory: true,
      deepTools: true,
      proactive: true,
      backgroundAgents: true,
      multiChannel: true,
    },
  },
};
```

#### D4. Update ALL Feature Construction Points in API Routes

Every place that constructs a `LicenseFeatures` object must include the 5 new flags.

**File:** `app/api/tier-templates/route.ts` (POST handler, ~line 35)
```typescript
const features: LicenseFeatures = {
  multiAgent: body.features?.multiAgent ?? false,
  maxAgents: body.features?.maxAgents ?? 1,
  multimodal: body.features?.multimodal ?? false,
  mcpHub: body.features?.mcpHub ?? false,
  allowedCapabilities: body.features?.allowedCapabilities ?? [],
  customBranding: body.features?.customBranding ?? false,
  gitlabKbSync: body.features?.gitlabKbSync ?? false,
  // ADD:
  soulMemory: body.features?.soulMemory ?? false,
  deepTools: body.features?.deepTools ?? false,
  proactive: body.features?.proactive ?? false,
  backgroundAgents: body.features?.backgroundAgents ?? false,
  multiChannel: body.features?.multiChannel ?? false,
};
```

**File:** `app/api/tier-templates/[id]/route.ts` (PUT handler, ~line 80)
Same addition for the feature merge logic.

**File:** `app/api/customers/[id]/license/route.ts` (POST handler, ~line 90)
Same addition for the custom features construction.

#### D5. Update TierTemplatesManager Feature Editor UI

**File:** `components/TierTemplatesManager.tsx`

The `FeatureEditor` component (lines ~118-190) only renders toggles for:
- multiAgent, multimodal, mcpHub, customBranding, gitlabKbSync

**Add toggles for:**
- soulMemory ("Soul & Memory")
- deepTools ("Deep Tools")
- proactive ("Proactive Engine")
- backgroundAgents ("Background Agents")
- multiChannel ("Multi-Channel")

Also update the `defaultFeatures` constant at top of file to include the 5 new flags as `false`.

### ğŸŸ¡ Should Fix (Gap)

#### D6. Fix Customer Detail Page License Generation

**File:** `app/customers/[id]/page.tsx`

The legacy `licenseTierFeatures` mapping (lines ~90-120) and `allFeatures` array (lines ~125-140) use completely wrong feature IDs (`basic_agents`, `sso`, `audit_logs`, etc.) that don't exist in the actual license system.

**Options:**
1. **Remove** the inline license generation from customer detail page entirely â€” redirect to `/licensing?customer={id}` (the dedicated licensing page already works better)
2. **Rewrite** to use the `tierTemplateId`-based flow that the licensing page uses

Option 1 is recommended â€” the `/licensing` page is the proper workflow.

#### D7. Update Licensing Page Feature Preview

**File:** `app/licensing/page.tsx` (lines ~200-215)

The feature preview section only shows badges for:
- multiAgent, multimodal, mcpHub, customBranding, gitlabKbSync

**Add badges for:**
- soulMemory, deepTools, proactive, backgroundAgents, multiChannel

#### D8. Update Tier Template Feature Display

**File:** `components/TierTemplatesManager.tsx` (template card rendering, lines ~270-295)

Same issue â€” only shows badges for 5 original features. Add display for the 5 new ones.

#### D9. Seed Migration for Existing Templates

If the admin app already has seeded tier templates in the database, they'll have the old feature set. Need either:
- A DB migration to update existing template features
- A "re-seed" button that updates existing defaults to v2 presets
- Or document that admins should delete and re-seed templates

#### D10. Fix Auth Cookie Security

**File:** `lib/auth.ts`

Replace static cookie value with signed JWT or encrypted token:
```typescript
// Instead of 'authenticated', use a signed token
const token = jwt.sign({ authenticated: true }, AUTH_SECRET, { expiresIn: '7d' });
cookieStore.set(AUTH_COOKIE_NAME, token, { ... });
```

#### D11. License Decode Page

No dedicated UI exists to paste a license key and decode it to inspect features. The `decodeLicenseWithoutVerification()` function exists in `lib/license.ts` but isn't exposed in any UI.

#### D12. License Secret from ENV Not DB

**File:** `lib/license.ts` â€” `getLicenseSecret()`

Currently reads only from `process.env.LICENSE_SECRET`. The settings page lets you store a license secret in the DB, but the license generation code doesn't read from DB. Either:
- Read from DB (like `lib/github.ts` does for GitHub token)
- Or remove the DB option from settings and keep it ENV-only

### ğŸŸ¢ Nice to Have

#### D13. Rename Package

**File:** `package.json` â€” change `"name": "nextjs_temp"` â†’ `"name": "agentinabox-platform-admin"`

#### D14. Clean Up Temp Directories

Hundreds of `tmpclaude-*-cwd` directories in project root. Add to `.gitignore` and delete.

#### D15. Break Up Giant Component

**File:** `app/customers/[id]/page.tsx` (2300+ lines)

Decompose into:
- `CustomerInfo.tsx`
- `CustomerRepo.tsx`
- `CustomerCollaborators.tsx`
- `CustomerLicense.tsx`
- `CustomerCapabilities.tsx`
- `CustomerNotes.tsx`

#### D16. Add License Validation Endpoint

Add `GET /api/validate-license` that accepts a license key string and returns decoded features + validity status. Useful for debugging customer issues.

---

## E. Missing v2 Feature Flags â€” Full Checklist

| v2 Feature Flag | Type | In Admin App? | In Tier Templates? | In Feature Editor UI? |
|----------------|------|---------------|--------------------|-----------------------|
| `multiAgent` | boolean | âœ… | âœ… | âœ… |
| `maxAgents` | number | âœ… | âœ… | âœ… |
| `multimodal` | boolean | âœ… | âœ… | âœ… |
| `mcpHub` | boolean | âœ… | âœ… | âœ… |
| `allowedCapabilities` | string[] | âœ… | âœ… | âœ… |
| `customBranding` | boolean | âœ… | âœ… | âœ… |
| `gitlabKbSync` | boolean | âœ… | âœ… | âœ… |
| **`soulMemory`** | boolean | âŒ **MISSING** | âŒ | âŒ |
| **`deepTools`** | boolean | âŒ **MISSING** | âŒ | âŒ |
| **`proactive`** | boolean | âŒ **MISSING** | âŒ | âŒ |
| **`backgroundAgents`** | boolean | âŒ **MISSING** | âŒ | âŒ |
| **`multiChannel`** | boolean | âŒ **MISSING** | âŒ | âŒ |

**5 out of 12 feature flags are completely absent from the admin app.** They need to be added to:
1. `lib/db/schema.ts` â€” `LicenseFeatures` interface
2. `lib/license.ts` â€” `BASE_FEATURES`, `FULL_FEATURES`, `DEFAULT_TIER_TEMPLATES`
3. `components/TierTemplatesManager.tsx` â€” `defaultFeatures` constant + `FeatureEditor` component
4. `app/licensing/page.tsx` â€” feature preview badges
5. `app/api/tier-templates/route.ts` â€” POST feature construction
6. `app/api/tier-templates/[id]/route.ts` â€” PUT feature merge
7. `app/api/customers/[id]/license/route.ts` â€” POST custom feature construction

---

## F. Files That Need Changes (Summary)

| File | Change Type | Severity |
|------|------------|----------|
| `lib/db/schema.ts` | Add 5 flags to LicenseFeatures | ğŸ”´ |
| `lib/license.ts` | Update BASE/FULL_FEATURES + tier presets | ğŸ”´ |
| `components/TierTemplatesManager.tsx` | Add 5 toggles to FeatureEditor + defaultFeatures | ğŸ”´ |
| `app/api/tier-templates/route.ts` | Add 5 flags to POST feature construction | ğŸ”´ |
| `app/api/tier-templates/[id]/route.ts` | Add 5 flags to PUT feature merge | ğŸ”´ |
| `app/api/customers/[id]/license/route.ts` | Add 5 flags to custom features construction | ğŸ”´ |
| `app/licensing/page.tsx` | Add feature preview badges for 5 new flags | ğŸŸ¡ |
| `app/customers/[id]/page.tsx` | Remove/rewrite stale license generation UI | ğŸŸ¡ |
| `lib/auth.ts` | Fix auth cookie security | ğŸŸ¡ |
| `package.json` | Rename from nextjs_temp | ğŸŸ¢ |

---

## G. Bottom Line

**The admin app is architecturally solid but frozen at v1.** The JWT signing, payload structure, and overall workflow are correct and compatible. The single root cause is that 5 v2 feature flags were never added to the admin app's data model. Once those 5 flags are added everywhere (interface â†’ defaults â†’ tier presets â†’ API routes â†’ UI), the admin app will be fully compatible with v2.

**Estimated effort:** 2-3 hours for a developer familiar with both codebases. Most changes are mechanical (add the same 5 fields to ~7 files).
